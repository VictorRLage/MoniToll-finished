<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <link rel="apple-touch-icon" sizes="76x76" href="assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="assets/img/favicon.png">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>
    Monitoll - Dashboard
  </title>
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no'
    name='viewport' />
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css"
    integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
  <!-- CSS Files -->
  <link href="assets/css/bootstrap.min.css" rel="stylesheet" />
  <link href="assets/css/now-ui-dashboard.css" rel="stylesheet" />
</head>

<body class="">
  <div class="wrapper ">
    <div class="sidebar" data-color="orange">
      <!--
        Tip 1: You can change the color of the sidebar using: data-color="blue | green | orange | red | yellow"
    -->
      <div class="logo">
        <a href="../../index.html" class="simple-text logo-mini">
          MT
        </a>
        <a href="../../index.html" class="simple-text logo-normal">
          MoniToll
        </a>
      </div>
      <div class="sidebar-wrapper" id="sidebar-wrapper">
        <ul class="nav">
          <li class="active ">
            <a href="./dashboard.html">
              <i class="now-ui-icons design_app"></i>
              <p class="maior">Dashboard</p>
            </a>
          </li>
          <li>
            <a href="./tables.html">
              <i class="now-ui-icons design_bullet-list-67"></i>
              <p class="maior">Registros</p>
            </a>
          </li>
          <li>
            <a href="./notifications.html">
              <i class="now-ui-icons ui-1_bell-53"></i>
              <p class="maior">Notificações</p>
            </a>
          </li>
          <li>
            <a href="">
              <i class="now-ui-icons travel_info"></i>
              <p class="maior">Contato</p>
            </a>
          </li>
          <li>
            <a href="">
              <i class="now-ui-icons business_badge"></i>
              <p class="maior">Adionar Usuario</p>
            </a>
          </li>
          <li class="active-pro">
            <a href="../../login.html">
              <i class="now-ui-icons sport_user-run"></i>
              <p class="maior">Sair</p>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="main-panel" id="main-panel">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-transparent  bg-primary  navbar-absolute">
        <div class="container-fluid">
          <div class="navbar-wrapper">
            <div class="navbar-toggle">
              <button type="button" class="navbar-toggler">
                <span class="navbar-toggler-bar bar1"></span>
                <span class="navbar-toggler-bar bar2"></span>
                <span class="navbar-toggler-bar bar3"></span>
              </button>
            </div>
            <a class="navbar-brand maior">Dashboard</a>
          </div>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation"
            aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-bar navbar-kebab"></span>
            <span class="navbar-toggler-bar navbar-kebab"></span>
            <span class="navbar-toggler-bar navbar-kebab"></span>
          </button>
          <div class="collapse navbar-collapse justify-content-end" id="navigation">
            <ul class="navbar-nav">
              <li class="nav-item" style="text-align: end; margin-right: 10px;">
                <span id="BemVindo">Bem vindo, Brands.<br> Adm</span>
              </li>
              <li class="nav-item">
                <a class="nav-link">
                  <i class="now-ui-icons users_single-02"></i>
                </a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" id="navbarDropdownMenuLink" data-toggle="dropdown"
                  aria-haspopup="true" aria-expanded="false">
                  <i class="now-ui-icons location_world"></i>
                  <p>
                    <span class="d-lg-none d-md-block">Some Actions</span>
                  </p>
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                  <a class="dropdown-item" href=""><img src="https://i.imgur.com/cLfSqm3.png"
                      style="width: 24px;"></img> Português</a>
                  <a class="dropdown-item" href=""><img src="https://i.imgur.com/lYq0cdt.png" style="width: 24px;">
                    English</a>
                  <a class="dropdown-item" href=""><img src="https://i.imgur.com/S5eEVok.png" style="width: 24px;">
                    Español</a>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <!-- End Navbar -->
      <div class="panel-header panel-header-sm">
      </div>
      <div class="content">
        <div class="row">
          <div class="col-md-12">
            <div class="cardResponsivo card">
              <div class="card-header">
                <h4 class="card-title">
                  <h2>Servidores</h2>
                </h4>
              </div>
              <div class="lista">
                <div id="open" class="CardDash">
                  <h3>Castelo branco</h3>
                  <img src="https://i.imgur.com/4OtEiKT.png" class="imgCardDash">
                </div>
                <div class="CardDash">
                  <h3>Avenida brasil</h3>
                  <img src="https://i.imgur.com/SKGlITE.png" class="imgCardDash">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <button onclick="ObterDataHora(101)">DataHora</button>
      <button onclick="ObterPorcentagemRAM(101)">Porcentagem uso ram</button>
      <button onclick="ObterPorcentagemPercaPacotes(101)">Porcentagem perca pacotes</button>
      <button onclick="PlotarGrafico(vetor_DataHora,101)">Plotar Grafico</button>
      <footer class="footer">
        <div class=" container-fluid ">
          <nav>
            <ul>
              <li>
                <a href="../../index.html">
                  MoniToll
                </a>
              </li>
              <li>
                <a href="../../sobre.html">
                  Sobre
                </a>
              </li>
              <li>
                <a href="../../contato.html">
                  Contato
                </a>
              </li>
            </ul>
          </nav>
          <div class="copyright" id="copyright">
            &copy; Copyright <a href="../../index.html">MoniToll.</a> Todos os direitos reservados
          </div>
        </div>
      </footer>
    </div>
  </div>


  <!-- modal grafico 1 -->
  <div class="modal-container" id="modal_container">
    <div class="modal-dash">
      <div class="modal-titulo">
        <h2>Castelo branco</h2>
      </div>
      <div class="modal-grafico">
        <canvas style="width: 1230px; display: block; height: 495px;" id="myChart"></canvas>
      </div>
      <button class="modal-close" id="close"><i class="now-ui-icons ui-1_simple-remove"></i></button>
    </div>
  </div>

</body>

</html>

<body>
  <!--   Core JS Files   -->
  <script src="assets/js/core/jquery.min.js"></script>
  <script src="assets/js/core/popper.min.js"></script>
  <script src="assets/js/core/bootstrap.min.js"></script>
  <script src="assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>
  <!-- Chart JS -->
  <script src="assets/js/plugins/chartjs.min.js"></script>
  <!--  Notifications Plugin    -->
  <script src="assets/js/plugins/bootstrap-notify.js"></script>
  <!-- Control Center for Now Ui Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="assets/js/now-ui-dashboard.min.js?v=1.5.0" type="text/javascript"></script>
  <!-- Now Ui Dashboard DEMO methods, don't include it in your project! -->
  <script src="assets/demo/demo.js"></script>
</body>

<script>
  const open = document.getElementById('open')
  const modal_container = document.getElementById('modal_container')
  const close = document.getElementById('close')

  open.addEventListener('click', () => { modal_container.classList.add('show') });
  close.addEventListener('click', () => { modal_container.classList.remove('show') });
</script>

<script>
  var vetor_DataHora = []
  var vetor_PorcentagemUsoRam = []
  var vetor_PorcentagemPercaPacotes = []
  var vetor_leituras = []

  function ObterDataHora(fkTorre) {
    fetch(`/medidas/DataHora/${fkTorre}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          console.log(resposta)
          resposta.reverse();
          resposta.forEach(element => {
            vetor_DataHora.push(element.DataHora.slice(11))
          });
          // PlotarGrafico(resposta, fkTorre);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }

  function ObterPorcentagemRAM(fkTorre) {
    fetch(`/medidas/PorcentagemRAM/${fkTorre}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          console.log(resposta)
          resposta.reverse();
          resposta.forEach(element => {
            vetor_PorcentagemUsoRam.push(element.PorcentagemUsoRam)
          });
          // PlotarGrafico(resposta, fkTorre);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }


  function ObterPorcentagemPercaPacotes(fkTorre) {
    fetch(`/medidas/PorcentagemPercaPacotes/${fkTorre}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();
          console.log(resposta)
          resposta.forEach(element => {
            vetor_PorcentagemPercaPacotes.push(element.PorcentagemPercaPacotes)
          });
          // PlotarGrafico(resposta, fkTorre);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }


  function PlotarGrafico(vetor_DataHora, fkTorre) {
    for (i = 0; i < vetor_DataHora.length; i++) {
      vetor_leituras.push({ DataHora: vetor_DataHora[i], PorcentagemUsoRam: vetor_PorcentagemUsoRam[i], PorcentagemPercaPacotes: vetor_PorcentagemPercaPacotes[i] })
    }

    console.log('iniciando plotagem do gráfico...');

    // Criando estrutura para plotar gráfico - labels
    let labels = [];

    // Criando estrutura para plotar gráfico - dados
    let dados = {
      labels: labels,
      datasets: [{
        label: 'Porcentagem uso RAM',
        data: [],
        fill: false,
        borderColor: 'rgb(75, 192, 192)',
        tension: 0.1
      },
      {
        label: 'Porcentagem perca pacotes',
        data: [],
        fill: false,
        borderColor: 'rgb(199, 52, 52)',
        tension: 0.1
      }]
    };

    console.log('----------------------------------------------')
    console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
    console.log(vetor_leituras)

    // Inserindo valores recebidos em estrutura para plotar o gráfico
    for (i = 0; i < vetor_leituras.length; i++) {
      var registro = vetor_leituras[i];
      labels.push(registro.DataHora);
      dados.datasets[0].data.push(registro.PorcentagemUsoRam);
      dados.datasets[1].data.push(registro.PorcentagemPercaPacotes);
    }

    console.log('----------------------------------------------')
    console.log('O gráfico será plotado com os respectivos valores:')
    console.log('Labels:')
    console.log(labels)
    console.log('Dados:')
    console.log(dados.datasets)
    console.log('----------------------------------------------')

    // Criando estrutura para plotar gráfico - config
    const config = {
      type: 'line',
      data: dados,
      options: {
        scales: {
          yAxes: [{
            ticks: {
              suggestedMin: 0,
              suggestedMax: 100
            }
          }]
        }
      }
    };

    // Adicionando gráfico criado em div na tela
    let myChart = new Chart(
      document.getElementById('myChart'),
      config
    );

    setTimeout(() => atualizarGrafico(fkTorre, dados, myChart), 30000);


  }


  function atualizarGrafico(fkTorre, dados, myChart) {
    fetch(`/medidas/tempo-real/${fkTorre}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (novoRegistro) {

          console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
          console.log(`Dados atuais do gráfico:`);
          console.log(dados);

          document.getElementById("avisoCaptura").innerHTML = ""

          if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
            console.log("---------------------------------------------------------------")
            console.log("Como não há dados novos para captura, o gráfico não atualizará.")
            document.getElementById("avisoCaptura").innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
            console.log("Horário do novo dado capturado:")
            console.log(novoRegistro[0].momento_grafico)
            console.log("Horário do último dado capturado:")
            console.log(dados.labels[dados.labels.length - 1])
            console.log("---------------------------------------------------------------")
          } else {
            // tirando e colocando valores no gráfico
            dados.labels.shift(); // apagar o primeiro
            dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

            dados.datasets[0].data.shift();  // apagar o primeiro de umidade
            dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

            dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
            dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

            myChart.update();
          }

          // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
          proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados, myChart), 2000);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
        proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados, myChart), 2000);
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }
</script>

<script>
  dados.labels.shift(); // apagar o primeiro
  dados.labels.push('sla'); // incluir um novo momento

  dados.datasets[0].data.shift();  // apagar o primeiro de umidade
  dados.datasets[0].data.push(50); // incluir uma nova medida de umidade

  dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
  dados.datasets[1].data.push(60); // incluir uma nova medida de temperatura

  myChart.update();

  setTimeout(() => atualizarGrafico(fkTorre, dados, myChart), 30000);


















  // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
  // buscando a última medida inserida em tabela contendo as capturas, 

  //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
  //     Para ajustar o "select", ajuste o comando sql em src/models
  function atualizarGrafico(fkTorre, dados, myChart) {

    fetch(`/medidas/tempo-real/${fkTorre}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (novoRegistro) {

          console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
          console.log(`Dados atuais do gráfico:`);
          console.log(dados);

          document.getElementById("avisoCaptura").innerHTML = ""

          if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
            console.log("---------------------------------------------------------------")
            console.log("Como não há dados novos para captura, o gráfico não atualizará.")
            document.getElementById("avisoCaptura").innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
            console.log("Horário do novo dado capturado:")
            console.log(novoRegistro[0].momento_grafico)
            console.log("Horário do último dado capturado:")
            console.log(dados.labels[dados.labels.length - 1])
            console.log("---------------------------------------------------------------")
          } else {
            // tirando e colocando valores no gráfico
            dados.labels.shift(); // apagar o primeiro
            dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

            dados.datasets[0].data.shift();  // apagar o primeiro de umidade
            dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

            dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
            dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

            myChart.update();
          }

          // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
          proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados, myChart), 2000);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
        proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados, myChart), 2000);
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });

  }
</script>